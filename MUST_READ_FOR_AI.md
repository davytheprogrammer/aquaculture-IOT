# MUST READ FOR AI - ESP32 Aquaculture IoT System Technical Troubleshooting Guide

## System Overview
ESP32-S3 based aquaculture monitoring system that reads sensor data and transmits to Supabase PostgreSQL database via HTTPS REST API.

## Database Schema

```sql
create table public.sensor_data (
  id bigint generated by default as identity not null,
  air_temperature double precision null,
  humidity double precision null,
  ph double precision null,
  ph_relay boolean null,
  created_at timestamp with time zone null default now(),
  user_id uuid null,
  water_temperature double precision null,
  dissolved_oxygen double precision null,
  turbidity double precision null,
  ammonia double precision null,
  aerator boolean null,
  filter boolean null,
  pump boolean null,
  constraint sensor_data_pkey primary key (id),
  constraint sensor_data_user_id_fkey foreign KEY (user_id) references auth.users (id) on delete CASCADE
);
```

**CRITICAL**: JSON payload field names MUST match database column names exactly:
- Use `air_temperature` NOT `temperature`
- All boolean fields: `ph_relay`, `aerator`, `filter`, `pump`
- All sensor readings: `water_temperature`, `dissolved_oxygen`, `turbidity`, `ammonia`

## SSL/TLS Certificate Issues

### Common Certificate Errors and Solutions

#### 1. `mbedtls_ssl_handshake returned -0x7780`
**Error Code**: `MBEDTLS_ERR_SSL_CONN_EOF`
**Cause**: SSL connection terminated during handshake
**Solutions**:
- Check URL scheme (must be `https://` not `http://`)
- Verify certificate chain completeness
- Increase timeout values

#### 2. `mbedtls_ssl_handshake returned -0x2700`
**Error Code**: `MBEDTLS_ERR_SSL_INVALID_RECORD`
**Cause**: Invalid SSL record, often HTTP/HTTPS mismatch
**Solutions**:
- Ensure URL uses `https://` scheme
- Check if server redirects HTTP to HTTPS (Status 301)
- Verify transport type is `HTTP_TRANSPORT_OVER_SSL`

#### 3. `mbedtls_ssl_handshake returned -0x3000`
**Error Code**: `MBEDTLS_ERR_X509_CERT_VERIFY_FAILED`
**Cause**: Certificate verification failed
**Solutions**:
- Use complete certificate chain (server + intermediate certificates)
- Verify certificate bundle includes required root CAs
- Check certificate expiration dates

#### 4. `No matching trusted root certificate found`
**Cause**: Certificate bundle missing required root CA
**Solutions**:
- Embed complete certificate chain in code
- Use `esp_crt_bundle_attach` for built-in certificate bundle
- Add specific root certificates to bundle

### Certificate Implementation Approaches

#### Approach 1: Certificate Bundle (Recommended)
```c
esp_http_client_config_t config = {
    .url = SUPABASE_URL,
    .transport_type = HTTP_TRANSPORT_OVER_SSL,
    .crt_bundle_attach = esp_crt_bundle_attach,
    .skip_cert_common_name_check = false
};
```

#### Approach 2: Hardcoded Certificate Chain
```c
static const char supabase_cert_chain[] = 
"-----BEGIN CERTIFICATE-----\n"
"[SERVER CERTIFICATE]\n"
"-----END CERTIFICATE-----\n"
"-----BEGIN CERTIFICATE-----\n"
"[INTERMEDIATE CERTIFICATE]\n"
"-----END CERTIFICATE-----\n";

esp_http_client_config_t config = {
    .url = SUPABASE_URL,
    .transport_type = HTTP_TRANSPORT_OVER_SSL,
    .cert_pem = supabase_cert_chain,
    .skip_cert_common_name_check = false
};
```

#### Approach 3: Skip Verification (NOT RECOMMENDED)
```c
esp_http_client_config_t config = {
    .url = SUPABASE_URL,
    .transport_type = HTTP_TRANSPORT_OVER_SSL,
    .skip_cert_common_name_check = true
};
```

## HTTP Status Code Troubleshooting

### Status Code Analysis

#### HTTP 200/201 - Success
- Data successfully inserted into database
- No action required

#### HTTP 400 - Bad Request
**Common Causes**:
1. **Field Name Mismatch**: JSON field names don't match database columns
2. **Data Type Mismatch**: Sending string where number expected
3. **Missing Required Fields**: Database constraints not satisfied
4. **Invalid JSON Format**: Malformed JSON payload

**Debugging Steps**:
1. Log response body: `esp_http_client_read_response()`
2. Verify JSON field names match database schema exactly
3. Check data types (double precision vs integer)
4. Validate JSON syntax

#### HTTP 401 - Unauthorized
**Causes**:
- Invalid API key
- Missing Authorization header
- Expired authentication token

**Solutions**:
```c
esp_http_client_set_header(client, "apikey", SUPABASE_KEY);
esp_http_client_set_header(client, "Authorization", "Bearer " SUPABASE_KEY);
```

#### HTTP 403 - Forbidden
**Causes**:
- Insufficient permissions for API key
- Row Level Security (RLS) policies blocking insert
- Database user lacks INSERT permissions

#### HTTP 500 - Internal Server Error
**Causes**:
- Database constraint violations
- Trigger function errors
- Server-side processing errors

### Connection Error Codes

#### `ESP_ERR_HTTP_CONNECT`
**Causes**:
- Network connectivity issues
- DNS resolution failures
- SSL handshake failures
- Server unreachable

**Debugging**:
1. Test WiFi connectivity
2. Verify DNS resolution
3. Check SSL certificate issues
4. Validate server endpoint

## WiFi Connection Issues

### Common WiFi Errors

#### "No WiFi networks found"
**Causes**:
- WiFi hardware not initialized properly
- Antenna issues
- Configured SSIDs not available
- Scan timing issues

**Solutions**:
```c
// Add delays and retries
esp_wifi_start();
vTaskDelay(pdMS_TO_TICKS(2000)); // Wait for WiFi to start

// Retry scanning
for (int retry = 0; retry < 3; retry++) {
    esp_err_t scan_result = esp_wifi_scan_start(&scan_config, true);
    if (scan_result == ESP_OK) {
        esp_wifi_scan_get_ap_num(&ap_count);
        if (ap_count > 0) break;
    }
    vTaskDelay(pdMS_TO_TICKS(1000));
}
```

#### WiFi Connection Drops
**Solutions**:
- Implement reconnection logic
- Increase connection timeouts
- Add WiFi event handlers for disconnect events

## Memory Management Issues

### Guru Meditation Errors

#### `LoadProhibited` Exception
**Cause**: Null pointer dereference or invalid memory access
**Common Locations**:
- HTTP client operations after cleanup
- Accessing freed memory
- Buffer overflows

**Prevention**:
```c
// Always check pointers before use
if (supabase_client) {
    esp_http_client_perform(supabase_client);
}

// Proper cleanup order
cleanup_supabase_client();
supabase_client = NULL;
```

#### Stack Overflow
**Causes**:
- Large local variables (JSON buffers)
- Deep recursion
- Insufficient stack size

**Solutions**:
- Use heap allocation for large buffers
- Reduce local variable sizes
- Increase task stack size

## Sensor Reading Issues

### Sensor Error Codes and Meanings

#### DS18B20 Water Temperature
- **"CRC check failed"**: Sensor not connected or faulty wiring
- **Returns -999.0**: Error sentinel value indicating read failure

#### pH Sensor (ADC)
- **"ADC channel reading failed"**: Sensor not connected to specified GPIO
- **Returns -999.0**: Error sentinel value

#### DHT22 Air Temperature/Humidity
- **"DHT22 timeout"**: Sensor communication failure
- **"Invalid checksum"**: Data corruption during transmission

### Sensor Connection Verification
```c
// Check if sensor reading is valid
if (water_temp != -999.0f) {
    // Valid reading
} else {
    // Sensor error - don't send invalid data
}
```

## JSON Payload Construction

### Correct JSON Format
```json
{
  "air_temperature": 29.1,
  "humidity": 38.6,
  "water_temperature": 25.5,
  "ph": 7.2,
  "dissolved_oxygen": 8.5,
  "turbidity": 12.3,
  "ammonia": 0.1,
  "ph_relay": true,
  "aerator": true,
  "filter": false,
  "pump": false
}
```

### Field Validation Rules
- **Temperature fields**: Double precision, can be negative
- **pH**: Range 0-14, double precision
- **Boolean fields**: Must be `true` or `false` (not `"true"` or `"false"`)
- **Sensor errors**: Use -999.0 for failed readings

## Debugging Techniques

### Enable Detailed Logging
```c
// Log HTTP response details
ESP_LOGI(TAG, "Status: %d", esp_http_client_get_status_code(client));
ESP_LOGI(TAG, "Content Length: %d", esp_http_client_get_content_length(client));

// Log response body for 400 errors
if (status_code == 400) {
    char response_buffer[512];
    int data_read = esp_http_client_read_response(client, response_buffer, sizeof(response_buffer) - 1);
    if (data_read > 0) {
        response_buffer[data_read] = '\0';
        ESP_LOGE(TAG, "Error Response: %s", response_buffer);
    }
}
```

### Certificate Chain Verification
```bash
# Get complete certificate chain
echo | openssl s_client -servername domain.com -connect domain.com:443 -showcerts

# Verify certificate chain
openssl verify -CAfile ca-bundle.crt server.crt
```

### Network Connectivity Testing
```c
// Test basic connectivity before HTTPS
esp_err_t ping_result = esp_ping_new_session(&ping_config, NULL, &ping_handle);
```

## Configuration Best Practices

### HTTP Client Configuration
```c
esp_http_client_config_t config = {
    .url = SUPABASE_URL,
    .method = HTTP_METHOD_POST,
    .timeout_ms = 15000,                    // Reasonable timeout
    .transport_type = HTTP_TRANSPORT_OVER_SSL,
    .cert_pem = certificate_chain,          // Use complete chain
    .skip_cert_common_name_check = false,   // Enable verification
    .buffer_size = 2048,                    // Adequate buffer size
    .buffer_size_tx = 1024
};
```

### Retry Logic Implementation
```c
#define MAX_RETRIES 3
int retry_count = 0;
int delay_ms = 1000;

while (retry_count < MAX_RETRIES) {
    esp_err_t err = esp_http_client_perform(client);
    int status = esp_http_client_get_status_code(client);
    
    if (err == ESP_OK && (status == 200 || status == 201)) {
        return true; // Success
    }
    
    if (retry_count < MAX_RETRIES - 1) {
        vTaskDelay(pdMS_TO_TICKS(delay_ms));
        delay_ms *= 2; // Exponential backoff
    }
    retry_count++;
}
```

## Common Pitfalls and Solutions

### 1. Certificate Expiration
- **Problem**: Hardcoded certificates expire
- **Solution**: Use certificate bundle or implement certificate update mechanism

### 2. Memory Leaks
- **Problem**: HTTP clients not properly cleaned up
- **Solution**: Always call cleanup functions and set pointers to NULL

### 3. Buffer Overflows
- **Problem**: JSON payload exceeds buffer size
- **Solution**: Calculate required buffer size or use dynamic allocation

### 4. Blocking Operations
- **Problem**: Long HTTP timeouts block other tasks
- **Solution**: Use reasonable timeouts and implement proper task scheduling

### 5. Error Handling
- **Problem**: Not handling all possible error conditions
- **Solution**: Implement comprehensive error checking and logging

## Performance Optimization

### Reduce Memory Usage
- Use smaller buffer sizes where possible
- Implement streaming for large payloads
- Free resources immediately after use

### Improve Reliability
- Implement watchdog timers
- Add connection health checks
- Use exponential backoff for retries

### Network Efficiency
- Reuse HTTP connections when possible
- Implement connection pooling
- Compress payloads if supported

## Security Considerations

### API Key Management
- Never hardcode production API keys
- Use secure storage for sensitive credentials
- Implement key rotation mechanisms

### Certificate Validation
- Always validate certificates in production
- Use certificate pinning for critical applications
- Monitor certificate expiration dates

### Data Validation
- Validate all sensor readings before transmission
- Implement data sanitization
- Use prepared statements equivalent (parameterized queries)

This document should be referenced whenever SSL/TLS, HTTP, or database connectivity issues arise in the ESP32 aquaculture monitoring system.
